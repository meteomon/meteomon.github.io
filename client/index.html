<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meteomon</title>
    <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
    <link rel="stylesheet" href="css/styles.css"> <!-- Enllaç al fitxer CSS extern -->
</head>
<body>
<div id="loading-indicator" class="hidden"> Validació del client en curs</div>
<div class="cf-turnstile" data-sitekey="0x4AAAAAAA1aUVL_oDtGIZ9k" data-callback="javascriptCallback"></div>
<h1>Meteomon - Dades meteorològiques</h1>
<div id="myWidget"></div>
<p>Última actualització: <span id="timestamp">-</span></p>
<!-- Taula de Temperatura -->
<h2>Temperatura</h2>
<table>
    <thead>
    <tr>
        <th>Paràmetre</th>
        <th>Valor</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>Temperatura</td>
        <td id="outdoor.temperature">-</td>
    </tr>
    <tr>
        <td>Sensació tèrmica</td>
        <td id="outdoor.feels_like">-</td>
    </tr>
    <tr>
        <td>Punt de rosada</td>
        <td id="outdoor.dew_point">-</td>
    </tr>
    <tr>
        <td>Temperatura aparent </td>
        <td id="outdoor.app_temp">-</td>
    </tr>
    </tbody>
</table>

<!-- Taula d'Humitat i Pressió -->
<h2>Humitat i Pressió</h2>
<table>
    <thead>
    <tr>
        <th>Paràmetre</th>
        <th>Valor</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>Humitat</td>
        <td id="outdoor.humidity">-</td>
    </tr>
    <tr>
        <td>Pressió relativa</td>
        <td id="pressure.relative">-</td>
    </tr>
    <tr>
        <td>Pressió absoluta</td>
        <td id="pressure.absolute">-</td>
    </tr>
    </tbody>
</table>

<!-- Taula de Vent -->
<h2>Vent</h2>
<table>
    <thead>
    <tr>
        <th>Paràmetre</th>
        <th>Valor</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>Velocitat màxima del vent (ràfega)</td>
        <td id="wind.gust">-</td>
    </tr>
    <tr>
        <td>Direcció del vent</td>
        <td id="wind.direction">-</td>
    </tr>
    <tr>
        <td>Velocitat del vent</td>
        <td id="wind.speed">-</td>
    </tr>
    </tbody>
</table>

<!-- Taula de Pluja -->
<h2>Pluja</h2>
<table>
    <thead>
    <tr>
        <th>Paràmetre</th>
        <th>Valor</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>Pluja per hora</td>
        <td id="rain.hourly">-</td>
    </tr>
    <tr>
        <td>Pluja diària</td>
        <td id="rain.daily">-</td>
    </tr>
    <tr>
        <td>Pluja setmanal</td>
        <td id="rain.weekly">-</td>
    </tr>
    <tr>
        <td>Pluja mensual</td>
        <td id="rain.monthly">-</td>
    </tr>
    <tr>
        <td>Pluja anual</td>
        <td id="rain.yearly">-</td>
    </tr>
    <tr>
        <td>Pluja d'event</td>
        <td id="rain.event">-</td>
    </tr>
    <tr>
        <td>Taxa de pluja</td>
        <td id="rain.rate">-</td>
    </tr>
    </tbody>
</table>

<!-- Taula Solar -->
<h2>Solar</h2>
<table>
    <thead>
    <tr>
        <th>Paràmetre</th>
        <th>Valor</th>
    </tr>
    </thead>
    <tbody>
    <tr>
        <td>Radiació solar</td>
        <td id="solar.solar">-</td>
    </tr>
    <tr>
        <td>Índex UV</td>
        <td id="solar.uvi">-</td>
    </tr>
    </tbody>
</table>

<script>
    let socket = null;

    function showLoadingIndicator(show) {
        const loadingIndicator = document.getElementById('loading-indicator');
        if (show) {
            loadingIndicator.classList.remove('hidden');
        } else {
            loadingIndicator.classList.add('hidden');
        }
    }

    function waitForTurnstileResponse() {
        // Polling until the Turnstile token is generated
        const interval = setInterval(() => {
            const tokenElement = document.querySelector("[name='cf-turnstile-response']");
            const token = tokenElement ? tokenElement.value : null;

            if (token) {
                clearInterval(interval); // Stop polling
                openWebSocket(token); // Open the WebSocket with the token
            }
        }, 100); // Check every 100ms
    }

    function openWebSocket(token) {
        if (!token) {
            console.error("Cannot open WebSocket: Token is null");
            showLoadingIndicator(false);
            return;
        }

        socket = new WebSocket(`wss://meteomon.antartica.pro/?token=${encodeURIComponent(token)}`);

        socket.onopen = () => {
            console.log("Connected to Antarctica Data Server Provider.");
            showLoadingIndicator(false); // Hide loading indicator
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            document.getElementById('timestamp').textContent = data.timestamp;
            
            document.getElementById('solar.solar').textContent = data.solar_solar;
            document.getElementById('solar.uvi').textContent = data.solar_uvi;

            document.getElementById('wind.gust').textContent = data.wind_gust;
            document.getElementById('wind.direction').textContent = data.wind_direction;

            document.getElementById('wind.speed').textContent = data.wind_speed;
            document.getElementById('pressure.absolute').textContent = data.pressure_absolute;

            document.getElementById('pressure.relative').textContent = data.pressure_relative;
            document.getElementById('rain.hourly').textContent = data.rain_hourly;
            document.getElementById('rain.daily').textContent = data.rain_daily;
            document.getElementById('rain.weekly').textContent = data.rain_weekly;
            document.getElementById('rain.monthly').textContent = data.rain_monthly;
            document.getElementById('rain.yearly').textContent = data.rain_yearly;
            document.getElementById('rain.event').textContent = data.rain_event;

            document.getElementById('rain.rate').textContent = data.rain_rate;
            document.getElementById('outdoor.temperature').textContent = data.outdoor_temperature;
            document.getElementById('outdoor.app_temp').textContent = data.outdoor_app_temp;
            document.getElementById('outdoor.feels_like').textContent = data.outdoor_feels_like;
            document.getElementById('outdoor.humidity').textContent = data.outdoor_humidity;

            document.getElementById('outdoor.dew_point').textContent = data.outdoor_dew_point;
        };

        socket.onclose = () => {
            console.log("Disconnected from Antarctica Data Server Provider. Refresh to connect again.");
        };

        socket.onerror = (error) => {
            console.error("Connection error:", error);
            showLoadingIndicator(false); // Hide loading indicator in case of error
        };
    }

    // Show the loading indicator when the page starts
    showLoadingIndicator(true);

    // Start waiting for Turnstile response
    waitForTurnstileResponse();
</script>
</body>
</html>
